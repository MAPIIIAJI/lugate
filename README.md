# Lugate
Lugate is a lua module for building JSON-RPC 2.0 Gateway APIs just inside of your Nginx configuration file.

[![Build Status](https://travis-ci.org/zinovyev/lugate.svg?branch=master)](https://travis-ci.org/zinovyev/lugate)

## About
Lugate is a helper set which is meant to be used together with [ngx\_http\_lua\_module](https://github.com/openresty/lua-nginx-module) module.
It provides you several special methods for validating a JSON-RPC 2.0 request, looping a batch call and building a
valid response.

## Install
Lugate can be installed via the luarocks package manager. Just run:
```bash
luarocks install lugate
```

## Synopsis
```lua
    server {
       listen       80;
        server_name  gateway.lugate.loc;

        access_log  /var/log/nginx/gateway_access.log;
        error_log  /var/log/nginx/gateway_error.log;

        location / {
              # MIME type determined by default_type:
              default_type 'application/json';

              content_by_lua_block {
                -- POST request
                if 'POST' == ngx.req.get_method() then
                  -- Load lugate module
                  local Lugate = require "lugate"

                  -- Get request body
                  ngx.req.read_body() -- explicitly read the req body
                  local body = ngx.req.get_body_data()
                  -- Get new lugate instance
                  local lugate = Lugate:new({
                    body = body,
                    routes = {
                      ["^v1%..+"] = "/v1",
                      ["^v2%..+"] = "/v2",
                    }
                  })

                  -- Loop requests
                  ngx_requests = {}
                  for _, request in ipairs(lugate:get_requests()) do
                    if request:is_valid() then
                      table.insert(ngx_requests,request:get_ngx_request())
                    else
                      ngx.say(lugate:get_json_error(Lugate.ERR_PARSE_ERROR))
                      return
                    end
                  end

                  -- Send multi requst and get multi response
                  responses = {ngx.location.capture_multi(ngx_requests)}
                  batch_responses = {}
                  for _, response in ipairs(responses) do
                    if 200 == response.status then
                      response_body = string.gsub(response.body, '%s$', '')
                      response_body = string.gsub(response_body, '^%s', '')
                      table.insert(batch_responses, response_body)
                    else
                      ngx.say(lugate:get_json_error(Lugate.ERR_INTERNAL_ERROR))
                    end
                  end

                  -- Print responses
                  if 1 == #batch_responses then
                    ngx.say(batch_responses[1])
                  else
                    ngx.print('[' .. table.concat(batch_responses, ",") .. ']')
                  end

                  return

                else
                  ngx.say(lugate:get_json_error(Lugate.ERR_INVALID_REQUEST, 'Only POST requests are allowed'))
                  return
                end
              }
        }
    }
```

## Lugate proxy call
Lugate brings its own protocol for transferring some additional logic over JSON-RPC 2.0 request to live. It adds
some additional capabilities for routing and caching.
The *params* member of the [request object](http://www.jsonrpc.org/specification#request_object) gets some additional mandatory members:

* **route** - fo the routing note
* **cache** - for the caching lifetime
* **params** - the regular array of parameter values

After the request is processed by the Lugate module, the **route** and **cache** values are removed from the
*params* member and the **params** value is expanded to fill the whole *params* field.

## API reference
To get the API reference use this [autogenerated doc](http://zinovyev.github.io/lugate).

## Testing
Use `busted` framework for running tests

## Running example from the project
First of all you have to install vagrant. Then go to the example folder and run:
```bash
vagrant up
```
Add this line to your local `/etc/hosts` file:
```
192.168.50.47 gateway.lugate.loc service01.lugate.loc service02.lugate.loc service03.lugate.loc
```
